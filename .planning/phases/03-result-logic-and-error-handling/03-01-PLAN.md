---
phase: 03-result-logic-and-error-handling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [public/ERC8004-SKILL.md]
autonomous: true
requirements: [VFY-07, VFY-08, VFY-10, TRUST-01]

must_haves:
  truths:
    - "An agent reading ## Result knows to lowercase both addresses before comparing and can apply the rule without ambiguity about case sensitivity"
    - "An agent reading ## Result sees the explicit OR condition: verified if recovered signer matches EITHER getAgentWallet OR ownerOf"
    - "An agent encountering a network error, address mismatch, or unregistered agent knows the distinct recommended response for each case from ## Error Conditions"
    - "An agent reading ## Trust Forwarding understands conceptually how to relay a verification result without being constrained to a prescribed format"
  artifacts:
    - path: "public/ERC8004-SKILL.md"
      provides: "Filled ## Result, ## Error Conditions, and ## Trust Forwarding sections replacing Phase 3 placeholders"
      contains: "verified = (signer_lower == wallet_lower) OR (signer_lower == owner_lower)"
  key_links:
    - from: "## Result"
      to: "### Step 2, ### Step 3, ### Step 4"
      via: "Cross-references to step outputs (recovered address, agent wallet, NFT owner)"
      pattern: "from Step [234]"
    - from: "## Error Conditions"
      to: "## Result"
      via: "References verification outcome states (verified, not verified, error)"
      pattern: "Network error|Address mismatch|Unregistered agent"
---

<objective>
Write the Result, Error Conditions, and Trust Forwarding sections into `public/ERC8004-SKILL.md`, replacing the three `<!-- Phase 3 -->` placeholders.

Purpose: Complete the verification logic documentation so agents have an unambiguous pass/fail rule, know how to handle each error case distinctly, and understand how to relay results downstream.

Output: `public/ERC8004-SKILL.md` with all Phase 3 content filled in.
</objective>

<execution_context>
@/home/teresa/.claude/get-shit-done/workflows/execute-plan.md
@/home/teresa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-result-logic-and-error-handling/03-RESEARCH.md
@public/ERC8004-SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write Result, Error Conditions, and Trust Forwarding sections</name>
  <files>public/ERC8004-SKILL.md</files>
  <action>
Replace the three `<!-- Phase 3 -->` comment placeholders in `public/ERC8004-SKILL.md` with the final content for each section. All three sections are a single coherent unit — write them together.

**## Result section** (replaces first `<!-- Phase 3 -->`):

1. One intro sentence: "Lowercase all three addresses, then compare."
2. Pseudocode block (not in a language-tagged code fence — use bare triple backticks):

```
signer_lower  = <recovered address from Step 2>.toLowerCase()
wallet_lower  = <agent wallet from Step 3>.toLowerCase()
owner_lower   = <NFT owner from Step 4>.toLowerCase()

verified = (signer_lower == wallet_lower) OR (signer_lower == owner_lower)
```

3. Annotation bullet list below the pseudocode (show-then-explain pattern):
   - `signer_lower`: recovered signer from `personal_ecRecover`, lowercased
   - `wallet_lower`: agent wallet from `getAgentWallet`, lowercased
   - `owner_lower`: NFT owner from `ownerOf`, lowercased
   - `verified`: true if either comparison matches — both addresses are authorized signers for the agent

4. One-liner inline explaining WHY lowercase: "`personal_ecRecover` returns EIP-55 checksummed (mixed-case) addresses; `eth_call` results are lowercase hex. Lowercasing both sides ensures consistent comparison."

Do NOT add H3 subsections under ## Result. Do NOT reference ## Error Conditions from within ## Result. Do NOT add any diagnostic display instructions (agents decide what to show).

**## Error Conditions section** (replaces second `<!-- Phase 3 -->`):

One intro sentence: "Three conditions require distinct handling." Then a table:

| Condition | What Happened | Recommended Response |
|-----------|---------------|---------------------|
| Network error | An RPC call failed before returning an address | Report: unable to complete verification due to network error. Do not report as unverified. |
| Address mismatch | All calls succeeded; recovered signer matches neither registry address | Report: NOT VERIFIED. The signature is not from an authorized key for this agent. |
| Unregistered agent | `eth_call` returned zero address or empty for `getAgentWallet` or `ownerOf` | Report: agent identity not found in registry. Verification cannot be completed. |

Do NOT add H3 subsections. Do NOT add explanatory paragraphs after the table — the table is self-contained. Do NOT conflate the three conditions or give them the same response.

**## Trust Forwarding section** (replaces third `<!-- Phase 3 -->`):

One paragraph only, terse spec tone, conceptual framing. Content:

An agent that has verified a signed block may communicate the result to downstream agents by stating the outcome (verified, not verified, or error), the verified identity (full ID), and the content hash. The verifying agent's own identity should accompany the attestation — downstream agents evaluate trust based on who is relaying the result, not the format of the relay.

Do NOT prescribe field names, data structures, JSON schemas, or transport protocols. Do NOT add multiple paragraphs. Do NOT add examples.

**Style constraints (from prior phase decisions):**
- Terse spec tone — imperatives, minimal prose
- Show-then-explain — code block first, annotation bullets after
- No separate "why" sections
- Cross-reference steps by name ("from Step 2", "from Step 3", "from Step 4")
  </action>
  <verify>
1. `grep "<!-- Phase 3 -->" public/ERC8004-SKILL.md` returns NO matches (all three placeholders replaced)
2. `grep "toLowerCase" public/ERC8004-SKILL.md` returns matches in the ## Result section
3. `grep "Network error" public/ERC8004-SKILL.md` returns a match in the ## Error Conditions table
4. `grep "Address mismatch" public/ERC8004-SKILL.md` returns a match in the ## Error Conditions table
5. `grep "Unregistered agent" public/ERC8004-SKILL.md` returns a match in the ## Error Conditions table
6. `grep "downstream agents" public/ERC8004-SKILL.md` returns a match in ## Trust Forwarding
7. No `###` headings appear between `## Result` and `## Error Conditions`, or between `## Error Conditions` and `## Trust Forwarding`
  </verify>
  <done>
All three `<!-- Phase 3 -->` placeholders are replaced with final content. ## Result contains the lowercase comparison pseudocode with explicit OR condition and annotation bullets. ## Error Conditions contains a three-row table with distinct recommended responses for network error, address mismatch, and unregistered agent. ## Trust Forwarding contains one conceptual paragraph with no format prescription. No H3 subsections added to any of the three sections.
  </done>
</task>

</tasks>

<verification>
1. Zero `<!-- Phase 3 -->` placeholders remain in `public/ERC8004-SKILL.md`
2. The comparison rule uses `.toLowerCase()` on all three addresses and states the OR condition explicitly
3. The three error conditions have three DISTINCT recommended responses (not the same response for all)
4. Trust forwarding is exactly one paragraph with no prescribed format, field names, or data structures
5. No H3 headings added in any Phase 3 section
6. Document heading structure (`## Result`, `## Error Conditions`, `## Trust Forwarding`) unchanged from skeleton
</verification>

<success_criteria>
An agent following the complete ERC8004-SKILL.md document can:
- Apply the address comparison rule without ambiguity (lowercase + OR)
- Handle each of the three error conditions with the correct distinct response
- Understand conceptually how to relay verification results
</success_criteria>

<output>
After completion, create `.planning/phases/03-result-logic-and-error-handling/03-01-SUMMARY.md`
</output>
